<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebXR AR + Hand Tracking</title>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
<canvas id="xr-canvas"></canvas>
<script>
  let scene, camera, renderer, controller, reticle, model;
  let xrRefSpace, gl;

  init();

  async function init() {
    // Set up scene
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera();
    renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('xr-canvas'), alpha: true });
    renderer.xr.enabled = true;

    document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test', 'hand-tracking'] }));

    const session = await navigator.xr.requestSession('immersive-ar', {
      requiredFeatures: ['hit-test', 'hand-tracking'],
      optionalFeatures: ['dom-overlay'],
      domOverlay: { root: document.body }
    });

    renderer.xr.setSession(session);

    gl = renderer.getContext();

    const xrRefSpaceTemp = await session.requestReferenceSpace('local');
    const viewerSpace = await session.requestReferenceSpace('viewer');
    const hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
    xrRefSpace = xrRefSpaceTemp;

    // Reticle
    const geometry = new THREE.RingGeometry(0.05, 0.06, 32).rotateX(-Math.PI / 2);
    const material = new THREE.MeshBasicMaterial({ color: 0x0fff0, side: THREE.DoubleSide });
    reticle = new THREE.Mesh(geometry, material);
    reticle.matrixAutoUpdate = false;
    reticle.visible = false;
    scene.add(reticle);

    // Load 3D model
    const loader = new THREE.GLTFLoader();
    loader.load('model7.glb', (gltf) => {
      model = gltf.scene;
      model.scale.set(0.2, 0.2, 0.2);
      model.visible = false;
      scene.add(model);
    });

    renderer.setAnimationLoop((timestamp, frame) => {
      if (frame) {
        const referenceSpace = xrRefSpace;
        const viewerPose = frame.getViewerPose(referenceSpace);

        if (viewerPose) {
          const hitTestResults = frame.getHitTestResults(hitTestSource);
          if (hitTestResults.length > 0) {
            const hit = hitTestResults[0];
            const hitMatrix = new THREE.Matrix4().fromArray(hit.getPose(referenceSpace).transform.matrix);
            reticle.visible = true;
            reticle.matrix = hitMatrix;
            if (model && !model.visible) {
              model.position.setFromMatrixPosition(hitMatrix);
              model.visible = true;
            }
          }

          // Hand tracking logic
          for (const inputSource of session.inputSources) {
            if (inputSource.hand && model && model.visible) {
              const indexTip = inputSource.hand.get('index-finger-tip');
              const thumbTip = inputSource.hand.get('thumb-tip');
              if (indexTip && thumbTip) {
                const indexPose = frame.getJointPose(indexTip, referenceSpace);
                const thumbPose = frame.getJointPose(thumbTip, referenceSpace);

                if (indexPose && thumbPose) {
                  const dx = indexPose.transform.position.x - thumbPose.transform.position.x;
                  const dy = indexPose.transform.position.y - thumbPose.transform.position.y;
                  const dz = indexPose.transform.position.z - thumbPose.transform.position.z;
                  const distance = Math.sqrt(dx * dx + dy * dy + dz * dz);

                  // Simpan rotasi berdasarkan jarak jari (pinch gesture)
                  if (distance < 0.03) {
                    model.rotation.y += 0.05;
                  }
                }
              }
            }
          }
        }
      }
      renderer.render(scene, camera);
    });
  }
</script>
<!-- WebXR AR Button -->
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/webxr/ARButton.js"></script>
</body>
</html>
